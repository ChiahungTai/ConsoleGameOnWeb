<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<link href="css/style.css" rel="stylesheet">
		<link href="css/sweetalert.css" rel="stylesheet" type="text/css" >
		<script src="lib/jquery-1.11.2.min.js"></script>
		<script src="lib/sweetalert.min.js"></script> 
		<title>Web game pad demo</title>
	</head>
	<body>
		<div id="textDiv">
			Welcome to Gamepad.
		</div>
		<br>
		<br>
		<div id="mainDiv">
			<div id="gamePadDiv">				
				<img class="imgDiv" src="images/xbox_360_controller.png">				
				<div id="highlightButtonBallDiv"></div>
				<div id="highlightAxisBallDiv"></div>
			</div>
		</div>
		<script type="text/javascript">

			var rAF = window.requestAnimationFrame ||
			  window.mozRequestAnimationFrame ||
			  window.webkitRequestAnimationFrame;

			var rAFStop = window.cancelRequestAnimationFrame ||
			  window.mozCancelRequestAnimationFrame ||
			  window.webkitCancelRequestAnimationFrame;

			var start;
			var mainGamePadIndex = -1;

			window.addEventListener("gamepadconnected", function(e) {

				swal({   title: "Game pad connected!",   text: "I will close in 3 seconds.",  
					type: "success", timer: 3000,   showConfirmButton: false });

			  	console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
			    e.gamepad.index, e.gamepad.id,
			    e.gamepad.buttons.length, e.gamepad.axes.length);

			  	if ( e.gamepad.index == 0 )
			  		mainGamePadIndex = e.gamepad.index;

			  	if ( e.gamepad.index > 0 )
			  		alert("We just support one gamepad currently.");

			  var div = document.getElementById("textDiv");
    			div.textContent += "Game pad connected";

    			gameLoop();

			});

			window.addEventListener("gamepaddisconnected", function(e) {

				swal({   title: "Game pad disconnected!",   text: "I will close in 3 seconds.",  
					type: "warning", timer: 3000,   showConfirmButton: false });

			  console.log("Gamepad disconnected from index %d: %s",
			    e.gamepad.index, e.gamepad.id);
			  var div = document.getElementById("textDiv");
    			div.textContent += "Game pad disconnected";

    			 rAFStop(start);
			});

			var buttonPos = [

				{'x': '22%', 'y': '28%'},
				{'x': '22%', 'y': '50%'},
				{'x': '18%', 'y': '39%'},
				{'x': '26%', 'y': '39%'},
				{'x': '40%', 'y': '20%'},
				{'x': '25%', 'y': '20%'}

			];

			function buttonPressed( btn, index ) {

				if (typeof(btn) == "object") {

					if (btn.pressed || btn.value) {

						console.log("You press buttion " + index);
						var btnBallElement = $('#highlightButtonBallDiv')[0];	
						var pos = buttonPos[index];
						btnBallElement.style.left = pos.x;
						btnBallElement.style.top = pos.y;
						btnBallElement.style.display = 'block';
					}
					
				}

				return btn == 1.0;
			}

			function axisPressed( a ) {

				if (typeof(a) == "object") {
				    return (Math.abs(a.value) == 1.0);
				}

				return Math.abs(a) == 1.0;
			}

			function gameLoop() {

				var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads : []);
				
				if (!gamepads) {
				    return;
				}

				// disable btn highlight
				var btnBallElement = $('#highlightButtonBallDiv')[0];
				btnBallElement.style.display = 'none';
				// end of disable

				var gp = gamepads[0];

				for (var i = 0; i < gp.buttons.length; ++i) {

					if (buttonPressed(gp.buttons[i], i)) {
						
					}
				}

				for (i = 0; i < gp.axes.length; ++i) {

					if (i==2) {

					}
					else if (i==5) {

					}
					else if (axisPressed(gp.axes[i])) {
						console.log("You press axes " + i + " value " + gp.axes[i]);
					}
				}

				start = rAF(gameLoop);
			}

		</script>	
	</body>
</html>